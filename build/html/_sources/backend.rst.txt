Структура веб-сервера go
==========================

Общие положения
----------------------------

Код приложения лежит в папе **/cmd**. На текущий момент реализованы 2 модуля: **/log** и **/web**, первый из которых отвечает за логирование, а второй-- собственно за веб-сервер. Прочие модули, по мере написания, должны добавляться также в папку **/cmd**.

.. _loggo_label:

Модуль логирования
--------------------------------------

Модуль логирования лежит в папке **/log** и реализован в файле **log.go**. В этой же папке находятся и сами логи. Файл **log.go** включает в себя объявление двух глобальных переменных-логов ErrLog_ и InfoLog_,
первый из которых служит для записи информационных сообщений, второй -- для записи ошибок. Определена также константа MAXLOGFILES_ определяющая максимальное число лог-файлов в папке, а также две функции : SetFileLogger_ и CheckCountLogs_. SetFileLogger_ генерирует файл (или открывает существующий) по определенной маске, включающей в себя тип лога и текущее время, а CheckCountLogs_ проверяет, не вышло ли число лог-файлов за предельное количество, и удаляет старые логи, если это произошло.

Таблица 1.1 Переменные и константы **log.go**

+---------------------+-------------------+--------------------------------------+
|  Название переменной|  Тип данных       |  Описание                            |
+=====================+===================+======================================+
|       .. _ErrLog:   |   ``*`` log.Logger|    Логгер для ошибок                 |
|                     |                   |                                      |
|       ErrLog        |                   |                                      |
+---------------------+-------------------+--------------------------------------+
|         .. _InfoLog:|     `*` log.Logger|  Логгер для информации               |
|                     |                   |                                      |
|     InfoLog         |                   |                                      |
+---------------------+-------------------+--------------------------------------+
|     .. _MAXLOGFILES:|    int            | Максимальное число логов в лог файлах|
|                     |                   |                                      |
|     MAXLOGFILES     |                   |                                      |
+---------------------+-------------------+--------------------------------------+

Таблица 1.2 Функции и методы **log.go**

+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+
|    Названия функции/метода               |  Структура-источник|  Имя параметра|  Тип параметра   | Класс параметра|  Описание                                                        |
+==========================================+====================+===============+==================+================+==================================================================+
|                        .. _SetFileLogger:|                    |               |                  |                |  Создание логгера в файл                                         |
|                                          |                    |               |                  |                |                                                                  |
|SetFileLogger                             |                    |               |                  |                |                                                                  |
+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+
|                                          |                    |       filename|        string    |  входной       |      Имя файла                                                   |
+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+
|                                          |                    |      prefix   |        string    |    входной     |    Лог-префикс                                                   |
+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+
|                                          |                    |               |  ``*`` log.logger|    выходной    |    Результат                                                     |
+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+
|                       .. _CheckCountLogs:|                    |               |                  |                | Удаление старых логов, если количество логов превышает допустимое|
|                                          |                    |               |                  |                |                                                                  |
|CheckCountLogs                            |                    |               |                  |                |                                                                  |
+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+
|                                          |                    |    prefix     |     string       |     входной    | Лог-префикс                                                      |
+------------------------------------------+--------------------+---------------+------------------+----------------+------------------------------------------------------------------+


.. _webgo_label:

Веб-сервер
----------------------------------------

Логика самого веб-сервера находится в папке */web*. В ней содержатся следующие файлы, каждый из которых будет рассмотрен подробнее:

* access.go_
* auth.go_
* basictypes.go_
* conf.go_
* config.json
* handlersCustom.go_
* handlersGet.go_
* handlersPost.go_
* htmlhandler.go_
* main.go_
* route.go_

Настройка конфигурационного файла config.json
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 

В этом файле хранятся основные параметры конфигурации для работы веб-сервера, а именно хост, порт, где будет развернут веб-сервер, данные БД администрирования и данные дополнительных БД для получения данных.

.. _conf.go:

Загрузка конфигурации. **conf.go**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Файл **conf.go** отвечает за загрузку конфигурации из конфигурационного файла. В нем описаны необходимые структуры для загрузки  *config.json* и его интерпретации, а также функции LoadConfig_, загружающая данные из конфигурационного файла, и ApplyConfig_, преобразующая загруженную структуру в набор мета-переменных. 

Таблица 1.3 Типы и структуры **conf.go**

+---------------------------+---------------+---------------+------------------------------------------------------+
|  Название типа/структуры  |  Поле         |  Тип          |  Описание                                            |
+===========================+===============+===============+======================================================+
|          .. _ServerConfig:|               |  struct       |   Конфигурация сокета для веб-сервера                |
|                           |               |               |                                                      |
|ServerConfig               |               |               |                                                      |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  Host         |  string       |   Хост                                               |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  Port         |  string       |    Порт                                              |
+---------------------------+---------------+---------------+------------------------------------------------------+
|              .. _DBConfig:|               |    struct     |    Конфигурация БД                                   |
|                           |               |               |                                                      |
|DBConfig                   |               |               |                                                      |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  Host         |  string       |      Хост                                            |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  Port         |  string       |    Порт                                              |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  User         |  string       |   Пользователь БД                                    |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |   Password    |   string      |      Пароль                                          |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           | DBName        |  string       |     Название БД                                      |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           | Ssl           |  string       |     Настройка ssl                                    |
+---------------------------+---------------+---------------+------------------------------------------------------+
|               .. _OtherDB:|               |  struct       |      Структура для хранения дополнительных баз данных|
|                           |               |               |                                                      |
|OtherDB                    |               |               |                                                      |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           | DBName        |  string       |      Название БД в программе                         |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           | DBConfig      |  DBConfig_    |      Конфигурация БД                                 |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                .. _Config:|               |  struct       |      Общая структура для хранения конфигурации       |
|                           |               |               |                                                      |
|Config                     |               |               |                                                      |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  ServerConfig |  ServerConfig_|      Конфигурация сервера                            |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  AdminDBConfig|  DBConfig_    |      Конфигурация БД администрирования               |
+---------------------------+---------------+---------------+------------------------------------------------------+
|                           |  OtherDB      |  [] OtherDB_  |      Конфигурации прочих БД                          |
+---------------------------+---------------+---------------+------------------------------------------------------+


Таблица 1.4 Функции и методы **conf.go**

+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|    Названия функции/метода            |  Структура-источник|  Имя параметра|  Тип параметра   | Класс параметра|  Описание                                        |
+=======================================+====================+===============+==================+================+==================================================+
|                        .. _LoadConfig:|                    |               |                  |                |  Загрузка конфигурации из конфигурационного файла|
|                                       |                    |               |                  |                |                                                  |
|LoadConfig                             |                    |               |                  |                |                                                  |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                                       |                    |               |  Config_         |  выходной      |      Конфигурационная структура                  |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                                       |                    |               |   error          |    выходной    |    Ошибка                                        |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                       .. _ApplyConfig:|                    |               |                  |                |Разбиение конфигурации на мета-переменные         |
|                                       |                    |               |                  |                |                                                  |
|ApplyConfig                            |                    |               |                  |                |                                                  |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                                       |                    |     cfg       |      Config_     |     входной    |Конфигурационная структура                        |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                                       |                    |   serverstring|    string        |   выходной     |Строка для создания веб-сервера                   |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                                       |                    |       dbstring|     string       |   выходной     |    Строка для коннекта к БД администирования     |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+
|                                       |                    |      dbmap    | map[string]string|     выходной   |    Набор строк для подключения к прочим БД       |
+---------------------------------------+--------------------+---------------+------------------+----------------+--------------------------------------------------+



.. _basictypes.go:

Вспомогательные структуры. **basictypes.go**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В файле **basictypes.go** находятся структуры языка go, используемые для различных служебных целей в программе. Структуры User_ и Role_ содержат полную информацию об авторизированном пользователе. Эти две структуры инкапсулируются в структуру UserFullData_, которая используется в программе как основа для взаимодействия пользователя с веб-сервером. Структура UserProperties_, встроенная в User_ содержит  вспомогательные данные пользовтаеля, не влияющие на логику системы (например, имя или телефон). Структура DepList_ хранит информацию об отделе, а DepTree_--упорядоченный набор всех отделов. Структура CreateUser_ нужна для создания нового пользователя. Структура Session_ содержит основную информацию о текущей сессии. Наконец, структуры Edithtml_ и CreateHtml_ содержат набор необходимых индивидуальных параметров для загрузки соответсвующих html-страниц.

Таблица 1.5 Типы данных для **basictypes.go**

+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|   Название типа данных                                 | Поле           |  Тип            | Описание                                                                                                                                                                                                      |
+========================================================+================+=================+===============================================================================================================================================================================================================+
|                                              .. _User :|                | struct          |  Базовая структура, содержащая данные пользователя                                                                                                                                                            |
|                                                        |                |                 |                                                                                                                                                                                                               |
|User                                                    |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  UserIndex     | int             |      Индекс пользователя в БД                                                                                                                                                                                 |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Login         | string          |  Логин                                                                                                                                                                                                        |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  DepIndex      | int             |  Индекс отдела пользователя в БД                                                                                                                                                                              |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  DepName       | string          |  Название отдела                                                                                                                                                                                              |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  UserProperties| UserProperties_ |  Прочие свойства пользователя                                                                                                                                                                                 |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                     .. _UserProperties:|                |struct           |  Свойства пользователя, не несущие системной логики                                                                                                                                                           |
|                                                        |                |                 |                                                                                                                                                                                                               |
|UserProperties                                          |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  UserName      | string          |       Имя пользовтаеля                                                                                                                                                                                        |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  UserSurname   | string          |       Фамилия пользователя                                                                                                                                                                                    |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  UserMiddlename| string          |       Отчество пользователя                                                                                                                                                                                   |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Email         | string          |       e-mail пользователя                                                                                                                                                                                     |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Phone         | string          |       Телефон пользователя                                                                                                                                                                                    |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                         .. _CreateUser:|                |                 |                                                                                                                                                                                                               |
|                                                        |                |                 |       Структура для создания пользователя в БД                                                                                                                                                                |
|CreateUser                                              |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Login         | string          |        Логин                                                                                                                                                                                                  |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Password      | string          |        Пароль                                                                                                                                                                                                 |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  DepIndex      | int             |        Индекс отдела в БД                                                                                                                                                                                     |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Properties    | UserProperties_ |        Прочие данные пользователя                                                                                                                                                                             |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  AcceptedRoles | []int           |         Набор индексов ролей, присваеваемых пользователю                                                                                                                                                      |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                            .. _DepTree:|                |map[int] DepList_|    Дерево департаментов                                                                                                                                                                                       |
|                                                        |                |                 |                                                                                                                                                                                                               |
|DepTree                                                 |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                            .. _DepList:|  UserMiddlename|                 |                                                                                                                                                                                                               |
|                                                        |                |   struct        |    Структура, описывающая департамент                                                                                                                                                                         |
|DepList                                                 |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  DepIndex      | int             |     Индекс отдела в БД                                                                                                                                                                                        |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  DepName       | string          |       Название отдела                                                                                                                                                                                         |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                               .. _Role:|                | struct          |     Структура для описания ролей пользователя                                                                                                                                                                 |
|                                                        |                |                 |                                                                                                                                                                                                               |
|Role                                                    |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  RoleIndex     | int             |    Индекс роли в БД                                                                                                                                                                                           |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  RoleName      | string          |     Название роли                                                                                                                                                                                             |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  RoleFullname  | string          |      Подробное описание роли                                                                                                                                                                                  |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                       .. _UserFullData:|                | struct          |       Структура для хранения текущего пользователя и его роли                                                                                                                                                 |
|                                                        |                |                 |                                                                                                                                                                                                               |
|UserFullData                                            |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  User          | User_           |     Пользователь                                                                                                                                                                                              |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  Role          | Role_           |      Роль                                                                                                                                                                                                     |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                            .. _Session:|                | struct          |                                                                                                                                                                                                               |
|                                                        |                |                 |     Структура для хранения основных параметров сессиии                                                                                                                                                        |
|Session                                                 |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  SessionIndex  | string          |       Индекс сесии в БД                                                                                                                                                                                       |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  UserIndex     | string          |       Индекс пользователя в БД                                                                                                                                                                                |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  RoleIndex     | string          |      Индекс роли в БД                                                                                                                                                                                         |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                         .. _Createhtml:|                | struct          |   Набор индивидуальных настроек для загрузки страницы Createuser.html                                                                                                                                         |
|                                                        |                |                 |                                                                                                                                                                                                               |
|CreateHtml                                              |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  DepTree       | ``*`` DepTree_  |       Дерево департаментов                                                                                                                                                                                    |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  RoleList      | [] Role_        |     Список доступных ролей                                                                                                                                                                                    |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                           .. _Edithtml:|                | struct          |     Набор индивидуальных настроек для загрузки страницы Edituser.html                                                                                                                                         |
|                                                        |                |                 |                                                                                                                                                                                                               |
|EditHtml                                                |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|                                                        |  IsAdmin       | bool            | Переменная, определяющая тип редактирования: если значение *true*, то значит страница запрошена администратором для администрирования пользователей. Если *false* то пользователь входит в свой личный кабинет|
|                                                        |                |                 |                                                                                                                                                                                                               |
|                                                        |                |                 |                                                                                                                                                                                                               |
+--------------------------------------------------------+----------------+-----------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

.. _main.go:


Основная программа. **main.go**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В главном файле **main.go** происходит собственно загрузка конфигурации, после чего устанавливается пул соединений со всеми нужными базами данных, формируется набор сессионных переменных и происходит запуск веб-сервера. Обработчики запросов вынесены в **route.go**

.. _auth.go:

Авторизация пользователя. **auth.go**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В файле **auth.go** сосредоточены функции для авторизации пользователя и загрузки и распределения сопутствующей информации. Функция GetUserData_ получает из БД структуру UserFullData_
, т.е. информацию о пользователе и роли, с которой он авторизировался. Функция GetDepTree_ получает список департаментов в сортировке, актуальной для данного пользователя (если пользователь сопоставлен отделу, он отображается первым, если нет--первым идет пункт "Департамент отсутствует").Функции CreateSession_ и CloseSession_ создают и закрывают сессию соответственно. GetSessionIndex_ позволяет получить идентификатор сессии. Для работы с cookie используются функции CreateSessionCookies_, SetSessionCookies_, DeleteSessionCookies_, Первые две используются для создания cookie и записи данных сессии в них, а последняя--для очистки cookies от этих данных. Наконец, функция Cookie2Int_ нужна для преобразования строковых значений cookie в числа.

Таблица 1.6 Типы данных для **auth.go**

+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|    Названия функции/метода                          |  Структура-источник|  Имя параметра     |  Тип параметра           | Класс параметра|  Описание                                          |
+=====================================================+====================+====================+==========================+================+====================================================+
|                                     .. _GetUserData:|                    |                    |                          |                |  Загрузка конфигурации из конфигурационного файла  |
|                                                     |                    |                    |                          |                |                                                    |
|GetUserData                                          |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |    UserLogin       |  string                  |  входной       |    Логин                                           |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |    RoleIndex       |  int                     |    входной     |    Индекс роли                                     |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |    db              |    ``*`` sql.DB          |  входной       |   БД                                               |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |     UserData       |   UserFullData_          |   выходной     |   Полные данные пользователя и роли                |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                      .. _GetDepTree:|                    |                    |                          |                |Загрузка дерева отделов с учетом отдела пользователя|
|                                                     |                    |                    |                          |                |                                                    |
|GetDepTree                                           |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |     db             |     ``*`` sql.DB         |     входной    |  БД                                                |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |   idep_index       |   int                    |   входной      |Индекс отдела в БД                                  |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |       tree         |    ``*`` DepTree_        |   выходной     |    Дерево департаментов                            |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      err           | error                    |     выходной   |  Ошибка                                            |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                   .. _CreateSession:|                    |                    |                          |                |Создание сессии                                     |
|                                                     |                    |                    |                          |                |                                                    |
|CreateSession                                        |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |    UserIndex       |  int                     |    входной     |    Индекс пользователя                             |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |    RoleIndex       |  int                     |    входной     |    Индекс роли                                     |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |    RemoteAddr      |  string                  |    входной     |    IP адрес пользователя                           |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      db            |      ``*`` sql.DB        |     входной    |  БД                                                |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      CurrentSession| Session_                 |     выходной   |  Структура с данными сессии                        |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      err           | error                    |     выходной   |  Ошибка                                            |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                               .. _SetSessionCookies:|                    |                    |                          |                |Запись данных сессии в куки                         |
|                                                     |                    |                    |                          |                |                                                    |
|SetSessionCookies                                    |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |     SessionIndex   |     int                  |     входной    |  Индекс сессии                                     |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |   UserIndex        |   int                    |   входной      |Индекс пользователя                                 |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |     RoleIndex      |   int                    |   входной      |    Индекс роли                                     |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      w             | ``*`` http.ResponseWriter|     входной    |  responce                                          |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                            .. _CreateSessionCookies:|                    |                    |                          |                |Создание куки для хранения сессионных данных        |
|                                                     |                    |                    |                          |                |                                                    |
|CreateSessionCookies                                 |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |     Session        |    ``*`` Session         |     входной    |  Структура с данными сесиии                        |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      w             | ``*`` http.ResponseWriter|     входной    |  responce                                          |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                            .. _DeleteSessionCookies:|                    |                    |                          |                |Удаление куки с данными о сессии                    |
|                                                     |                    |                    |                          |                |                                                    |
|DeleteSessionCookies                                 |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      w             | ``*`` http.ResponseWriter|     входной    |  responce                                          |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                    .. _CloseSession:|                    |                    |                          |                |Закрытие сессии                                     |
|                                                     |                    |                    |                          |                |                                                    |
|CloseSession                                         |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      w             | ``*`` http.ResponseWriter|     входной    |  responce                                          |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      r             | ``*`` http.Request       |     входной    |  request                                           |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      db            | ``*`` sql.DBr            |     входной    |  БД                                                |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      err           | error                    |     выходной   |  Ошибка                                            |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                      .. _Cookie2Int:|                    |                    |                          |                |Получение целочисленных куки в виде числа           |
|                                                     |                    |                    |                          |                |                                                    |
|Cookie2Int                                           |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      r             | ``*`` http.Request       |     входной    |  request                                           |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      CookieName    | string                   |     входной    |  название куки                                     |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |                    | int                      |     входной    |  Значение                                          |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |                    | error                    |     выходной   |  Ошибка                                            |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                 .. _GetSessionIndex:|                    |                    |                          |                |Получение индекса сессии                            |
|                                                     |                    |                    |                          |                |                                                    |
|GetSessionIndex                                      |                    |                    |                          |                |                                                    |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |      r             | ``*`` http.Request       |     входной    |  request                                           |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |                    | int                      |     входной    |  Значение                                          |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+
|                                                     |                    |                    | error                    |     выходной   |  Ошибка                                            |
+-----------------------------------------------------+--------------------+--------------------+--------------------------+----------------+----------------------------------------------------+


.. _access.go:

Права доступа. **access.go**
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

В этом файле находится логика для распределения прав доступа для разных пользователей. Ключевой элемент -- структура AccessMap_ которая представляет собой карту, где ключами являются строки с названиями прав пользователей, а значения -- true, что означает, что права на данный функционал доступны. (Конечно, можно было использовать массив или срез, но в таком случае могли бы быть дубликаты, кроме того карта лучше подходит по логике). Метод структуры AccessMap_ HasPermission_ проверяет, есть ли доступ к запрашиваемому функционалу. Именно эот метод применяется для динамической генерации html-страниц. Метод Truncate_ позволяет полностью очистить матрицу прав доступа (например, при логауте). Функция Write2AccessMap_ нужна для заполнения AccessMap_ данными из БД. Функция GetBasicAccessMap_ формирует базовый набор прав, доступный пользователя без привязки к конкретной странице (например, доступные элементы главного меню). Структуры AccessMap_ и UserFullData_ составляют базовую структуру SessionData_, в которой инкапсулирована вся информация о пользователе, роли и его правах. Вместе же с набором баз данных *DBPool* они образуют структуру RouteData_, которая передается в обработчики событий, которые, в свою очередь, получают необходимую информацию из БД и динамически формируют ответы на http-запросы (например, геренрируют разный контент для html-страниц). Наконец, структура NeuteredFileSystem_ вместе с методом Open_ создают защищенный обработчик файлов (например, чтобы не была видна файловая структура папки **/static** сервера). На текущий момент, для удобства отладки, эта функция предстовляет из себя заглушку, однако в дальнейшем будет переписана.


Таблица 1.7. Типы данных для **access.go**

+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|  Название типа/структуры        |  Поле              |  Тип              |  Описание                                                                                                        |
+=================================+====================+===================+==================================================================================================================+
|                  .. _AccessMap :|                    |                   |    Матрица прав доступа. В карте ключами являются доступные права (строки-названия), а значениями значения *true*|
|                                 |                    | map[string]bool   |                                                                                                                  |
| AccessMap                       |                    |                   |                                                                                                                  |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                 .. _SessionData:|                    |    struct         |     Необходимый набор значений для сессии-- информация о пользовтаеле, роли и правах                             |
|                                 |                    |                   |                                                                                                                  |
|SessionData                      |                    |                   |                                                                                                                  |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 |UserData            | UserFullData_     |       Данные пользвателя и роли                                                                                  |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 |BasicAcceptedObjects|     AccessMap_    |       Список глобальных доступных объектов                                                                       |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                   .. _RouteData:|                    |    struct         |     Структура для переачи в маршрутизатор                                                                        |
|                                 |                    |                   |                                                                                                                  |
|RouteData                        |                    |                   |                                                                                                                  |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 | SessionData        |   SessionData_    |   Необходимые данные сессии                                                                                      |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 | DBPool             | map[string]*sql.DB|    Необходимый набор БД                                                                                          |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|          .. _NeuteredFileSystem:|                    |      struct       |     Защищенный обработчик файлов                                                                                 |
|                                 |                    |                   |                                                                                                                  |
|NeuteredFileSystem               |                    |                   |                                                                                                                  |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 |        Fs          |   http.FileSystem |        Коллекция файлов                                                                                          |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 |     SData          |  SessionData_     |        Данные сессии                                                                                             |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+
|                                 |      Db            |   ``*`` sql.DB    |            БД                                                                                                    |
+---------------------------------+--------------------+-------------------+------------------------------------------------------------------------------------------------------------------+

Таблица 1.8 Функции и методы **access.go**

+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|    Названия функции/метода                 |  Структура-источник   |  Имя параметра|  Тип параметра | Класс параметра|  Описание                                                              |
+============================================+=======================+===============+================+================+========================================================================+
|                        .. _HasPermission:  |       AccessMap_      |               |                |                |    Проверка, есть ли право доступа на определенный объект              |
|                                            |       SessionData_    |               |                |                |                                                                        |
|HasPermission                               |                       |               |                |                |                                                                        |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |     s         |     string     |   входной      |      Название проверяемого объекта                                     |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |               |    bool        |    выходной    |          Результат                                                     |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                             .. _Truncate:  |   AccessMap_          |               |                |                |   Очищает матрицу прав доступа                                         |
|                                            |                       |               |                |                |                                                                        |
|Truncate                                    |                       |               |                |                |                                                                        |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                 .. _Open:  |    NeuteredFileSystem_|               |                |                |Реализация стандартного go-интерфейса для работы защищенного обработчика|
|                                            |                       |               |                |                |                                                                        |
|Open                                        |                       |               |                |                |                                                                        |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |    path       |      string    |     входной    |Путь к файлу                                                            |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |               |    http.File   |   выходной     |Файл для открытия                                                       |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |               |   error        |   выходной     |  Ошибка                                                                |              
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                      .. _Write2AccessMap:  |                       |               |                |                |       Заполнение матрицы прав доступа                                  |
|                                            |                       |               |                |                |                                                                        |
|Write2AccessMap                             |                       |               |                |                |                                                                        |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |    am         |  AccessMap_    |     входной    |      Матрица прав доступа                                              |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |     db        | ``*`` sql.DB   |      входной   |         БД                                                             |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |     sql_query |   string       |      входной   |         Запрос для получения прав                                      |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |   queryargs   |    interface{} |      входной   |         Параметры запроса                                              |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |       err     |   error        |      выходной  |           Ошибка                                                       |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                      .. _GetBasicAccessMap:|                       |               |                |                |    Загрузка прав доступа к общим объектам для конкретной роли          |
|                                            |                       |               |                |                |                                                                        |
|GetBasicAccessMap                           |                       |               |                |                |                                                                        |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |     am        |     AccessMap_ |     входной    |   Матрица прав доступа                                                 |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |       db      |    ``*`` sql.DB|      входной   |       БД                                                               |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |      RoleIndex|       int      |      входной   |    Индекс роли из БД                                                   |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+
|                                            |                       |        err    |      error     |      выходной  |      Ошибка                                                            |
+--------------------------------------------+-----------------------+---------------+----------------+----------------+------------------------------------------------------------------------+

.. _route.go:

Обработчики событий.
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Обработка запросов. **route.go**
``````````````````````````````````````````````

Маршрутизация приложения описана в файле **route.go**. По сути, здесь описано какие функции нужно выполнять для определенных http-запросов.Фактически, это и есть основная функция, реализуемая веб-сервером. Детализация функций-обработчиков рассмотрена в файлах **handlersCustom.go**, **handlersGet.go**, **handlersPut.go** и  **htmlhandler.go**

Таблица 1.9 Переменные в **route.go**

+---------------------+------------+-------------------------------------------------------------------------------------------------+
|  Название переменной|  Тип данных|  Описание                                                                                       |
+=====================+============+=================================================================================================+
|       HeadersTmpl   |    []string|    Набор стандартных шаблонов для загрузки большинства веб-страниц (левое и верхние меню и т.п.)|
+---------------------+------------+-------------------------------------------------------------------------------------------------+



Таблица 1.10 Функции и методы **route.go**

+------------------------------+--------------------+---------------+---------------------+----------------+-------------------------------------------------+
|    Названия функции/метода   |  Структура-источник|  Имя параметра|  Тип параметра      | Класс параметра|  Описание                                       |
+==============================+====================+===============+=====================+================+=================================================+
|                   .. _routes:|                    |               |                     |                | Функция, прописывающая маршруты по http-запросам|
|                              |                    |               |                     |                |                                                 |
|routes                        |                    |               |                     |                |                                                 |
+------------------------------+--------------------+---------------+---------------------+----------------+-------------------------------------------------+
|                              |                    |        r      |  ``*`` RouteData_   |  входной       |  Исходные данные для маршрутизатора             |
+------------------------------+--------------------+---------------+---------------------+----------------+-------------------------------------------------+
|                              |                    |               |  ``*`` http.ServeMux|    выходной    |  Маршрутизатор go                               |
+------------------------------+--------------------+---------------+---------------------+----------------+-------------------------------------------------+

.. _htmlhandler.go:

Стандартный генератор html-страниц. **htmlhandler.go**
````````````````````````````````````````````````````````````

В большинстве своем, если результатом запроса должна быть html-страница, то функция, реализующая подобный обработчик должна работать по определенному алгоритму: сначала проходит проверка матрицы прав доступа на предмет самой возможности доступа к этой странице. Затем, в случае отрицательного ответа, должен вызываться некоторый обработчик, сигнализирующий об отсутсвии прав, а в случае положительного ответа должен  выполняться повторный запрос в БД для определения прав доступа к отдельным элементам этой страницы, в результате чего происходит уже генерация html-страницы на основе доступных элементов. Именно такой функционал реализован структурой HtmlHandler_ в файле **htmlhandlers.go**.  В основе HtmlHandler_ лежит структура HtmlObjects_ куда входят структуры SessionData_  и AcceptedObjects_, несущие в себе информацию о пользователе и его правах (причем, структура AcceptedObjects_ содержит в себе права относящиеся непосредственно к запрашиваемой html, а в SessionData_ входят права пользователя на глобальные объекты) , структура PageMeta_ с мета-данными страницы, а также интерфейс CommonObjects_ в котором могут быть произвольные объекты, индивидуальные для каждой страницы, которые нужны для ее корректной генерации. (Например, для страницы создания пользователя :ref:`createuser_label`: это списки доступных отделов и ролей). Конечно, можно генерацию страниц проводить и на уровне скриптов javascript, динамически заполняя существующие поля, однако, в случае, если элемент статичен и берется из внешнего источника, имеет смысл генерация именно через шаблонизатор go. Также в структуру HtmlHandler_ входят обработчик событий на случай отсутсвия прав доступа к запрашиваемой странице, название генерируемой html, список шаблонов для ее генерации и ссылка на БД. Посредством методов HtmlHandler_ и AccessHandler_ данная структура  реализует  описанный в  начале алгоритм.

Таблица 1.11 Типы и структуры **htmlhandler.go**

+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|  Название типа/структуры         |  Поле                |  Тип                                          |  Описание                                                                                          |
+==================================+======================+===============================================+====================================================================================================+
|                     .. _PageMeta:|                      |  struct                                       |   Мета-данные страницы                                                                             |
|                                  |                      |                                               |                                                                                                    |
|PageMeta                          |                      |                                               |                                                                                                    |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  | PageName             |  string                                       |  Название                                                                                          |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  | PageHttp             |  string                                       |  http-запрос для отображения                                                                       |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  | PageDescribe         |  string                                       |  Краткое описание                                                                                  |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  | PageLogoClass        |  string                                       |  Тип логотипа                                                                                      |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                  .. _HtmlObjects:|                      |    struct                                     |  Набор объектов необходимый для динамической генерации html-страницы                               |
|                                  |                      |                                               |                                                                                                    |
|HtmlObjects                       |                      |                                               |                                                                                                    |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |    .. _CommonObjects:|  interface{}                                  |    Набор индивидуальных объектов для страницы                                                      |
|                                  |                      |                                               |                                                                                                    |
|                                  |   CommonObjects      |                                               |                                                                                                    |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |  SessionData         |  SessionData_                                 |    Общие данные сессии                                                                             |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |  .. _AcceptedObjects:|  AccessMap_                                   |   Набор прав доступа на индивидуальные объекты страницы                                            |
|                                  |                      |                                               |                                                                                                    |
|                                  |  AcceptedObjects     |                                               |                                                                                                    |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |  PageMeta            |  PageMeta_                                    |      Мета-данные страницы                                                                          |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                  .. _HtmlHandler:|                      |  struct                                       |      Универсальная структура для генерации html-страниц согласно матрице прав доступа              |
|                                  |                      |                                               |                                                                                                    |
|HtmlHandler                       |                      |                                               |                                                                                                    |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  | DenyHandler          |  func(http.ResponseWriter, ``*`` http.Request)|     Обработчик события в случае отсутствии прав на отображение страницы                            |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  | SourceHtml           |  string                                       |      Имя генерируемой html-страницы (как в БД) для загрузки прав доступа на объекты внутри страницы|
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |  PathSourceHtml      |  []string                                     |     Набор путей для загрузки необходимых шаблонов и html-страниц в go                              |                                                       
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |  HtmlData            |  HtmlObjects_                                 |      Данные для динамической генерации страницы                                                    |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+
|                                  |  Db                  |  ``*`` sql.DB                                 |      БД                                                                                            |
+----------------------------------+----------------------+-----------------------------------------------+----------------------------------------------------------------------------------------------------+

Таблица 1.12 Функции и методы **htmlhandler.go**

+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+
|    Названия функции/метода                |  Структура-источник|  Имя параметра|  Тип параметра       | Класс параметра|  Описание                                                                           |
+===========================================+====================+===============+======================+================+=====================================================================================+
|                           .. _DenyHandler:|      HtmlHandler_  |               |                      |                | Общий обработчик события на http-запрос                                             |
|                                           |                    |               |                      |                |                                                                                     |
|HtmlHandle                                 |                    |               |                      |                |                                                                                     |
+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+
|                                           |                    |    w          |   http.ResponseWriter|   входной      |     ответ на http-запрос                                                            |
+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+
|                                           |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                                                      |
+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+
|                         .. _AccessHandler:|      HtmlHandler_  |               |                      |                |Обработчик события на http-запрос при успешной проверке прав доступа на html-страницу|
|                                           |                    |               |                      |                |                                                                                     |
|AccesHandler                               |                    |               |                      |                |                                                                                     |
+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+
|                                           |                    |    w          |   http.ResponseWriter|   входной      |     ответ на http-запрос                                                            |
+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+
|                                           |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                                                      |
+-------------------------------------------+--------------------+---------------+----------------------+----------------+-------------------------------------------------------------------------------------+


.. _handlersCustom.go:

Специфические обработчики событий. **handlersCustom.go**
`````````````````````````````````````````````````````````````````

В файле **handlersCustom.go** описаны обработчики событий, которые не подлежат адекватной группировке с остальными. Сюда относится генератор главной страницы и формы авторизации, а также обработчики для входа/выхода из системы. Первые два просто генерируют нужные html-страницы. Обработчик авторизации LoginHandler_ проверяет корректность пары логин-пароль и, в случае успешной авторизации, открывает новую сессию и заполняет базовую матрицу прав доступа для пользовтаеля с учетом его выбранной роли. В конечном итоге происходит перенаправление на главную страницу. Обработчик выхода LogoutHandler_  закрывает сессию, стирает данные пользователя и очищает матрицу прав доступа, после чего происходит переход на главную страницу.

Таблица 1.13 Функции и методы **handlersCustom.go**

+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|    Названия функции/метода                 |  Структура-источник|  Имя параметра|  Тип параметра       | Класс параметра|  Описание                                                 |
+============================================+====================+===============+======================+================+===========================================================+
|                             .. _DenyHandle:|                    |               |                      |                | Общий обработчик события на http-запрос при отказе доступа|
|                                            |                    |               |                      |                |                                                           |
|DenyHandler                                 |                    |               |                      |                |                                                           |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    w          |   http.ResponseWriter|   входной      |     ответ на http-запрос                                  |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                            |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                           .. _IndexHandler:|                    |               |                      |                |Показ главной страницы                                     |
|                                            |                    |               |                      |                |                                                           |
|IndexHandler                                |                    |               |                      |                |                                                           |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    w          |   http.ResponseWriter|   входной      |    ответ на http-запрос                                   |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                            |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    sd         |    ``*`` SessionData_|    входной     |    параметры сессии                                       |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                            .. _AuthHandler:|                    |               |                      |                |Показ страницы авторизации                                 |
|                                            |                    |               |                      |                |                                                           |
|AuthHandler                                 |                    |               |                      |                |                                                           |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    w          |   http.ResponseWriter|   входной      |    ответ на http-запрос                                   |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                            |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    sd         |    ``*`` SessionData_|    входной     |    параметры сессии                                       |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                           .. _LoginHandler:|                    |               |                      |                |Авторизация пользователя в системе                         |
|                                            |                    |               |                      |                |                                                           |
|                                  .. _login:|                    |               |                      |                |                                                           |
|                                            |                    |               |                      |                |                                                           |
|LoginHandler                                |                    |               |                      |                |                                                           |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    w          |   http.ResponseWriter|   входной      |    ответ на http-запрос                                   |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                            |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    db         |  ``*``  sql.DB       |    входной     |     БД                                                    |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    sd         |    ``*`` SessionData_|    входной     |    параметры сессии                                       |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                          .. _LogoutHandler:|                    |               |                      |                |Выход пользователя из системы                              |
|                                            |                    |               |                      |                |                                                           |
|LogoutHandler                               |                    |               |                      |                |                                                           |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    w          |   http.ResponseWriter|   входной      |    ответ на http-запрос                                   |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |     r         |    ``*`` http.Request|    входной     |    http запрос                                            |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    db         | ``*``  sql.DB        |     входной    |     БД                                                    |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+
|                                            |                    |    sd         |    ``*`` SessionData_|    входной     |    параметры сессии                                       |
+--------------------------------------------+--------------------+---------------+----------------------+----------------+-----------------------------------------------------------+

.. _handlersGet.go:

Обработчики get-запросов. **handlersGet.go**
````````````````````````````````````````````````````````

Файл **handlersGet.go** состоит из набора функций, обеспечивающих ответ на get-запросы к веб-серверу. Большинство из них нужны для интерактивной работы html-страниц и служат источником для ajax-запросов из соответствующих скриптов. Основная функция-шаблон для получения информации из БД это JsonFromSqlFuncHandler_ которая возвращает из базы данных json в ответ на некоторый запрос (**важно**: корректность формируемого json, равно как и то, что БД формирует именно json  не проверяется на этом уровне. Проверяется лишь сам факт корректного ответа от БД). По этому шаблону работают функции GetRolesHandler_, GetNoRolesHandler_, GetAllRolesHandler_, GetUsersHandler_, GetDepHandler_ (первые три нужны для получения ролей, присвоенных и неприсвоенных пользователю соответственно, третья--для получения всех доступных ролей, а последние две--получение списка пользователей и департаментов). По этому же приниципу работают функции, получающие данные для тестовых страниц с таблицами из тестовой БД (Якутии).


Таблица 1.14 Функции и методы **handlersGet.go**

+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|    Названия функции/метода                              |  Структура-источник |  Имя параметра|  Тип параметра           | Класс параметра       |  Описание                                        |
+=========================================================+=====================+===============+==========================+=======================+==================================================+
|                              .. _JsonFromSqlFuncHandler:|                     |               |                          |                       | Загрузка JSON из БД через SQL-запрос             |
|                                                         |                     |               |                          |                       |                                                  |
|JsonFromSqlFuncHandler                                   |                     |               |                          |                       |                                                  |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    w          |   http.ResponseWriter    |   входной             |    ответ на http-запрос                          |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |     r         |    ``*`` http.Request    |    входной            |    http запрос                                   |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |   db          |   ``*`` sql.DB           |                       |БД                                                |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    querystr   |   string                 |   входной             |    SQL-запрос                                    |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    queryargs  |     ...interface{}       |    входной            |    параметры SQL-запроса                         |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                     .. _GetRolesHandler:|                     |               |                          |                       | Получение списка присвоенных пользователю ролей  |
|                                                         |                     |               |                          |                       |                                                  |
|GetRolesHandler                                          |                     |               |                          |                       |                                                  |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    w          |   http.ResponseWriter    |   входной             |    ответ на http-запрос                          |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |     r         |    ``*`` http.Request    |    входной            |    http запрос                                   |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |   db          |   ``*`` sql.DB           |                       |БД                                                |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                   .. _GetNoRolesHandler:|                     |               |                          |                       | Получение списка неприсвоенных пользователю ролей|
|                                                         |                     |               |                          |                       |                                                  |
|GetNoRolesHandler                                        |                     |               |                          |                       |                                                  |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    w          |   http.ResponseWriter    |   входной             |    ответ на http-запрос                          |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |     r         |    ``*`` http.Request    |    входной            |    http запрос                                   |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |   db          |   ``*`` sql.DB           |                       |БД                                                |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                  .. _GetAllRolesHandler:|                     |               |                          |                       | Получение списка всех ролей                      |
|                                                         |                     |               |                          |                       |                                                  |
|GetAllRolesHandler                                       |                     |               |                          |                       |                                                  |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    w          |   http.ResponseWriter    |   входной             |    ответ на http-запрос                          |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |     r         |    ``*`` http.Request    |    входной            |    http запрос                                   |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |   db          |   ``*`` sql.DB           |                       |БД                                                |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                     .. _GetUsersHandler:|                     |               |                          |                       | Получение списка всех пользователей              |
|                                                         |                     |               |                          |                       |                                                  |
|GetUsersHandler                                          |                     |               |                          |                       |                                                  |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    w          |   http.ResponseWriter    |   входной             |    ответ на http-запрос                          |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |     r         |    ``*`` http.Request    |    входной            |    http запрос                                   |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |   db          |   ``*`` sql.DB           |                       |БД                                                |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                       .. _GetDepHandler:|                     |               |                          |                       | Получение списка всех отделов                    |
|                                                         |                     |               |                          |                       |                                                  |
|GetDepHandler                                            |                     |               |                          |                       |                                                  |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |    w          |   http.ResponseWriter    |   входной             |    ответ на http-запрос                          |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |     r         |    ``*`` http.Request    |    входной            |    http запрос                                   |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+
|                                                         |                     |   db          |   ``*`` sql.DB           |                       |БД                                                |
+---------------------------------------------------------+---------------------+---------------+--------------------------+-----------------------+--------------------------------------------------+


.. _handlersPost.go:

Обработчики post-запросов. **handlersPost.go**
````````````````````````````````````````````````````````

Аналогично, файл **handlersPost.go** содержит функции для ответа на post-запросы. Стандартная функция-шаблон здесь SaveJson2DbHandler_ позволяющая сохранить json в БД (**важно** корректность json на этом уровне не проверяется). По этому принципу реализован обработчик смены пароля пользовтаелем ChangePasswordByUserHandler_, а также тестовые функции для сохранения суточных и часовых данных. Функции EditAcceptHandler_ и CreateAcceptHandler_ несут несколько более сложную логику. CreateAcceptHandler_ проверяет входящий json и отсекает пустые поля (актуально для UserProperties_). Для функции EditAcceptHandler_ важен еще и источник редактирования: это может быть как редактирование пользователем своих личных данных, так и редактирвоание администратором других пользовтаелей. В первом случае, помимо сохранения изменений в БД необходимо обновить данные пользовтаеля в сессии. Наконец, UpdateUserRolesHandler_ позволяет обновить доступные пользователем роли, но в отличие от SaveJson2DbHandler_ , который возвращает только ошибку, она возвращает количество добавленных и удаленных ролей (в целом, это нужно для отладки, в перспективе можно убрать и привести к стандарту). 

Таблица 1.15 Функции и методы **handlersPost.go**

+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|    Названия функции/метода                                     |  Структура-источник |  Имя параметра|  Тип параметра       | Класс параметра     |  Описание                                                 |
+================================================================+=====================+===============+======================+=====================+===========================================================+
|                                         .. _SaveJson2DbHandler:|                     |               |                      |                     | Сохранение JSON в БД через SQL-запрос (выполнение функции)|
|                                                                |                     |               |                      |                     |                                                           |
|SaveJson2DbHandler                                              |                     |               |                      |                     |                                                           |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    w          |   http.ResponseWriter|   входной           |    ответ на http-запрос                                   |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |     r         |    ``*`` http.Request|    входной          |    http запрос                                            |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |   db          |   ``*`` sql.DB       |                     |    БД                                                     |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    query      |   string             |   входной           |    SQL-запрос                                             |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                  .. _EditAcceptHandler:        |                     |               |                      |                     | Сохранение изменений пользователя в БД                    |
|                                                                |                     |               |                      |                     |                                                           |
|EditAcceptHandler                                               |                     |               |                      |                     |                                                           |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    w          |   http.ResponseWriter|   входной           |    ответ на http-запрос                                   |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |     r         |    ``*`` http.Request|    входной          |    http запрос                                            |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |   db          |   ``*`` sql.DB       |                     |    БД                                                     |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    sData      |   SessionData_       |   входной           |    параметры сессии                                       |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+ 
|                                       .. _CreateAcceptHandler: |                     |               |                      |                     |Создание пользователя в БД                                 |
|                                                                |                     |               |                      |                     |                                                           |
|CreateAcceptHandler                                             |                     |               |                      |                     |                                                           |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    w          |   http.ResponseWriter|   входной           |    ответ на http-запрос                                   |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |     r         |    ``*`` http.Request|    входной          |    http запрос                                            |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |   db          |   ``*`` sql.DB       |                     |    БД                                                     |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                .. _UpdateUserRolesHandler:     |                     |               |                      |                     |Изменение ролей пользователя в БД                          |
|                                                                |                     |               |                      |                     |                                                           |
|UpdateUserRolesHandler                                          |                     |               |                      |                     |                                                           |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    w          |   http.ResponseWriter|   входной           |    ответ на http-запрос                                   |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |     r         |    ``*`` http.Request|    входной          |    http запрос                                            |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |   db          |   ``*`` sql.DB       |                     |    БД                                                     |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                .. _ChangePasswordByUserHandler:|                     |               |                      |                     |Изменение пароля пользователя в БД самим пользователем     |
|                                                                |                     |               |                      |                     |                                                           |
|ChangePasswordByUserHandler                                     |                     |               |                      |                     |                                                           |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |    w          |   http.ResponseWriter|   входной           |    ответ на http-запрос                                   |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |     r         |    ``*`` http.Request|    входной          |    http запрос                                            |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+
|                                                                |                     |   db          |   ``*`` sql.DB       |                     |    БД                                                     |
+----------------------------------------------------------------+---------------------+---------------+----------------------+---------------------+-----------------------------------------------------------+












